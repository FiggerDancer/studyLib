import{_ as p,r as t,o,c,b as n,d as s,a as i,e as a}from"./app-72993491.js";const l={},r=a(`<h1 id="webpack配置" tabindex="-1"><a class="header-anchor" href="#webpack配置" aria-hidden="true">#</a> webpack配置</h1><h2 id="基本配置" tabindex="-1"><a class="header-anchor" href="#基本配置" aria-hidden="true">#</a> 基本配置</h2><h3 id="loader" tabindex="-1"><a class="header-anchor" href="#loader" aria-hidden="true">#</a> loader</h3><h4 id="loader调优先级" tabindex="-1"><a class="header-anchor" href="#loader调优先级" aria-hidden="true">#</a> loader调优先级</h4><p>前置知识：</p><ol><li>loader调用有优先级,可以通过enforce指定优先级，并且可以通过！符号在引入模块的时候定义是否要跳过某一种优先级的loader</li></ol><p>webpack.js.org 2. loader的调用有inline的方式，并且可以结合上面说的！符号指定跳过某些loader</p><p>webpack.js.org 3. pitch阶段的调用在normal之前，并且顺序和normal相反。详细过程见文章总结 4. pitch阶段某一个loader返回了值的话，就直接中断整个流程，把pitch的返回值作为本次文件的loader结果继续编译。比如上述的style-loader返回了对原来文件./xxx/less的引用，指定了使用css-loader less-loader loader继续加载，并且用了两个!!去跳过了配置文件中的所有loader防止无限递归。这里使用picth起到了类似<strong>虚拟节点</strong>的作用</p><h4 id="js、ts、jsx、tsx" tabindex="-1"><a class="header-anchor" href="#js、ts、jsx、tsx" aria-hidden="true">#</a> js、ts、jsx、tsx</h4><p>swc、esbuild、babel</p><h4 id="vue" tabindex="-1"><a class="header-anchor" href="#vue" aria-hidden="true">#</a> vue</h4><p>vue-loader</p><p>VueLoaderPlugin</p><h4 id="图片、音频、字体" tabindex="-1"><a class="header-anchor" href="#图片、音频、字体" aria-hidden="true">#</a> 图片、音频、字体</h4><p>file-loader、url-loader</p><h4 id="scss、less、css" tabindex="-1"><a class="header-anchor" href="#scss、less、css" aria-hidden="true">#</a> scss、less、css</h4><p>postcss-loader、sass-loader、less-loader、css-loader</p><p>Extract-Mini-CSS、</p><h4 id="html" tabindex="-1"><a class="header-anchor" href="#html" aria-hidden="true">#</a> html</h4><p>html-loader</p><p>HTMLWebpackPlugin</p><h4 id="markdown" tabindex="-1"><a class="header-anchor" href="#markdown" aria-hidden="true">#</a> markdown</h4><p>markdown-loader</p><h4 id="加速" tabindex="-1"><a class="header-anchor" href="#加速" aria-hidden="true">#</a> 加速</h4><p>thread-loader、thread-loader warm机制</p><h3 id="plugins" tabindex="-1"><a class="header-anchor" href="#plugins" aria-hidden="true">#</a> plugins</h3><p>插件用来干除了打包之外的自动化工作</p><p>举例：</p><p>清除 cleanWebpackPlugin</p><p>复制 copyWebpackPlugin 一般只有生产用</p><p>打包速度 speedPlugin</p><p>压缩图片 imageminPlugin</p><p>生成html htmlWebpackPlugin</p><p>压缩文件 zipPlugin</p><p>压缩代码 terserPlugin</p><p>抽取css MiniCssExtractPlugin</p><p>体积分析插件 Analysis</p><p>进度插件 progress</p><p>定义全局变量 DefinePlugin</p><h4 id="手写一个插件" tabindex="-1"><a class="header-anchor" href="#手写一个插件" aria-hidden="true">#</a> 手写一个插件</h4><p>钩子机制（类似事件机制），写插件先看文档，要用什么钩子</p><p>清除注释</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">class</span> <span class="token class-name">MyPlugin</span> <span class="token punctuation">{</span>
    <span class="token function">apply</span><span class="token punctuation">(</span><span class="token parameter">compiler</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;MyPlugin 启动&#39;</span><span class="token punctuation">)</span>

        compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>emit<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">&#39;MyPlugin&#39;</span><span class="token punctuation">,</span> <span class="token parameter">compilation</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token comment">// 可以理解为此次打包的上下文</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> name <span class="token keyword">in</span> compilation<span class="token punctuation">.</span>assets<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// console.log(name)</span>
                <span class="token comment">// console.log(compilation.assets[name].source)</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>name<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">&#39;.js&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">const</span> contents <span class="token operator">=</span> compilation<span class="token punctuation">.</span>assets<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token keyword">const</span> withoutComments <span class="token operator">=</span> contents<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token operator">/</span>\\<span class="token operator">/</span>\\<span class="token operator">*</span>\\<span class="token operator">*</span><span class="token operator">+</span>\\<span class="token operator">*</span>\\<span class="token operator">/</span>g<span class="token punctuation">,</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">)</span>
                    compilation<span class="token punctuation">.</span>assets<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
                        <span class="token function-variable function">source</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> withoutComments<span class="token punctuation">,</span>
                        <span class="token function-variable function">size</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> withoutComments<span class="token punctuation">.</span>length
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="watch模式" tabindex="-1"><a class="header-anchor" href="#watch模式" aria-hidden="true">#</a> watch模式</h3><p>监听文件变化，自动打包 + browser-sync 自动刷新页面</p><h3 id="webpack-dev-server" tabindex="-1"><a class="header-anchor" href="#webpack-dev-server" aria-hidden="true">#</a> webpack-dev-server</h3><p>集成自动编译和自动刷新页面。默认是把内容写在内存中</p><p>你引入的东西都可以访问，但是一些静态文件不可以访问，需要额外配置</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">devServer</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token doc-comment comment">/**
         * 额外资源位置
         */</span>
        <span class="token literal-property property">contentBase</span><span class="token operator">:</span> <span class="token string">&#39;./public&#39;</span><span class="token punctuation">,</span>
        <span class="token doc-comment comment">/**
         * 添加代理服务
         */</span>
        <span class="token literal-property property">proxy</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token string-property property">&#39;/api&#39;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                <span class="token comment">// https://localhost:8080/api/users =&gt; https://api.github.com/api/users</span>
                <span class="token literal-property property">target</span><span class="token operator">:</span> <span class="token string">&#39;https://api.github.com&#39;</span><span class="token punctuation">,</span>
                <span class="token comment">// https://localhost:8080/api/users =&gt; https://api.github.com/users</span>
                <span class="token literal-property property">pathRewrite</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                    <span class="token string-property property">&#39;^/api&#39;</span><span class="token operator">:</span> <span class="token string">&#39;&#39;</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token comment">// 不能使用localhost:8080作为请求Github的主机名，默认会使用本机主机名请求</span>
                <span class="token literal-property property">changeOrigin</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token operator">...</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="sourcemap" tabindex="-1"><a class="header-anchor" href="#sourcemap" aria-hidden="true">#</a> sourceMap</h3><div class="language-map line-numbers-mode" data-ext="map"><pre class="language-map"><code>{
    version: // sourcemap版本
    sources: 文件名
    names: 引用名称
    mappings: 映射
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="浏览器中运行代码" tabindex="-1"><a class="header-anchor" href="#浏览器中运行代码" aria-hidden="true">#</a> 浏览器中运行代码</h4><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token function">eval</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">console.log(123) //# sourceURL=./foo/bar.js</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h4 id="类型" tabindex="-1"><a class="header-anchor" href="#类型" aria-hidden="true">#</a> 类型</h4><p>eval 是否使用eval执行模块代码 cheap sourceMap是否包含行信息 module 是否能够得到Loader处理之前的源代码 inline 代码嵌入到文件中 hidden-source-map 生成文件，但是代码里不引入 nosources-source-map 看的到错误位置，但是看不到源代码(生产环境下)</p><p>eval 会将生成的代码放在eval里，不生成sourceMap只可以定位哪个文件出了错误，构建最快 cheap-eval-source-map 相较eval，有sourceMap有行信息 cheap-module-eval-source-map 最全的</p><p>开发模式 cheap-module-eval-source-map</p><h3 id="hmr-热更新" tabindex="-1"><a class="header-anchor" href="#hmr-热更新" aria-hidden="true">#</a> hmr 热更新</h3><ol><li>样式文件可以直接热更新</li><li>js文件，框架下每种文件有规律可以自动热更新,并没有通用的替换方案</li></ol><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">devServer</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token comment">// hot: true,</span>
        <span class="token comment">// 使用包装类，错误不会自动刷新</span>
        <span class="token literal-property property">hotOnly</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token operator">...</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="hmr-api" tabindex="-1"><a class="header-anchor" href="#hmr-api" aria-hidden="true">#</a> HMR API</h4><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">let</span> editor <span class="token operator">=</span> <span class="token function">createEditor</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

module<span class="token punctuation">.</span>hot<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token string">&#39;./editor&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;edit 模块更新了，需要手动跟新了&#39;</span><span class="token punctuation">)</span>
    document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>editor<span class="token punctuation">.</span>el<span class="token punctuation">)</span>
    editor <span class="token operator">=</span> <span class="token function">createEditor</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>editor<span class="token punctuation">.</span>el<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="图片热更新" tabindex="-1"><a class="header-anchor" href="#图片热更新" aria-hidden="true">#</a> 图片热更新</h4><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code>img<span class="token punctuation">.</span>src <span class="token operator">=</span> background
module<span class="token punctuation">.</span>hot<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token string">&#39;./better.png&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    img<span class="token punctuation">.</span>src <span class="token operator">=</span> background
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="defineplugin" tabindex="-1"><a class="header-anchor" href="#defineplugin" aria-hidden="true">#</a> DefinePlugin</h3><p>传入的js代码片段，而不是字符串</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">new</span> <span class="token class-name">webpack<span class="token punctuation">.</span>DefinePlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token constant">API</span><span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token string">&#39;sdfsdf&#39;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="tree-shaking" tabindex="-1"><a class="header-anchor" href="#tree-shaking" aria-hidden="true">#</a> Tree Shaking</h3><p>必须使用 esmodule</p><p>dead-code 未引用代码</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">mode</span><span class="token operator">:</span> <span class="token string">&#39;none&#39;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">entry</span><span class="token operator">:</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">output</span><span class="token operator">:</span> <span class="token punctuation">{</span>

    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">optimization</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token doc-comment comment">/**
         * 只导出的内容外面用的内容
         */</span>
        <span class="token literal-property property">usedExports</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token doc-comment comment">/**
         * 开启压缩，把上面那个没导出的部分给删掉
         */</span>
        <span class="token literal-property property">minimize</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token doc-comment comment">/**
         * 压缩插件
         */</span>
        <span class="token literal-property property">minimizer</span><span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token string">&#39;...&#39;</span><span class="token punctuation">,</span>
            <span class="token operator">...</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token doc-comment comment">/**
         * 尽可能将所有函数合并到同一个模块当中，
         * 提升效率，减少代码体积
         * Scope Hoisting
         * 作用域提升
         */</span>
        <span class="token literal-property property">concatenateModules</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>早期babel-loader有可能将esm转化为commonjs，现在会自动判断环境使用esm，不会导致tree-shaking问题</p><h3 id="sideeffects" tabindex="-1"><a class="header-anchor" href="#sideeffects" aria-hidden="true">#</a> sideEffects</h3><p>副作用，一般用于NPM标记是否有副作用</p><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;sideEffects&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-json line-numbers-mode" data-ext="json"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;sideEffects&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">&quot;./src/extend&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;*.css&quot;</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">mode</span><span class="token operator">:</span> <span class="token string">&#39;none&#39;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">entry</span><span class="token operator">:</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">output</span><span class="token operator">:</span> <span class="token punctuation">{</span>

    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">optimization</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token doc-comment comment">/**
         * 开启后依赖的npm包如果没用就不会打包进来
         */</span>
        <span class="token literal-property property">sideEffects</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token doc-comment comment">/**
         * 只导出的内容外面用的内容
         */</span>
        <span class="token comment">// usedExports: true,</span>
        <span class="token doc-comment comment">/**
         * 开启压缩，把上面那个没导出的部分给删掉
         */</span>
        <span class="token comment">// minimize: true,</span>
        <span class="token doc-comment comment">/**
         * 尽可能将所有函数合并到同一个模块当中，
         * 提升效率，减少代码体积
         * Scope Hoisting
         * 作用域提升
         */</span>
        <span class="token comment">// concatenateModules: true,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="webpack-hash" tabindex="-1"><a class="header-anchor" href="#webpack-hash" aria-hidden="true">#</a> webpack hash</h3><p>hash 项目级，项目有改变就改变 chunkhash chunk级 哪个chunk改了哪个变 contenthash 文件级hash</p><h2 id="性能优化" tabindex="-1"><a class="header-anchor" href="#性能优化" aria-hidden="true">#</a> 性能优化</h2><h3 id="构建性能优化" tabindex="-1"><a class="header-anchor" href="#构建性能优化" aria-hidden="true">#</a> 构建性能优化</h3><h4 id="swc或者esbuild" tabindex="-1"><a class="header-anchor" href="#swc或者esbuild" aria-hidden="true">#</a> swc或者esbuild</h4><p>swc-loader代替babel-loader，如果项目使用的是vue，依然需要引入babel来处理jsx文件，swc默认支持react的jsx。</p><p>通过.swcrc配置swc</p><p>速度比用babel快了6倍左右，如果使用turpopack或者rspack速度还会更快，遗憾的是turpopack不支持vue，rspack大概还能在webpack+swc基础上快一倍，但不支持分包时的name为函数，tsx文件不能引入vue，polyfill引入必须用entry,不过一般而言，webpack+swc的运行速度已经可以满足大部分要求</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token literal-property property">modules</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">rules</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
            <span class="token literal-property property">test</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\\.m?[tj]s$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
            <span class="token literal-property property">use</span><span class="token operator">:</span> <span class="token punctuation">[</span>
                <span class="token punctuation">{</span>
                    <span class="token literal-property property">loader</span><span class="token operator">:</span> <span class="token string">&#39;swc-loader&#39;</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="cache-持久化缓存" tabindex="-1"><a class="header-anchor" href="#cache-持久化缓存" aria-hidden="true">#</a> cache 持久化缓存</h4><p>本地缓存的问题，就是有时你只改某个文件，另一个文件没改，打包时不更新，我开启了一段时间，大部分时间没啥问题，但是一有问题就很头疼，所以我最后关闭了</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token punctuation">{</span>
  <span class="token literal-property property">cache</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&quot;filesystem&quot;</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="thread-loader" tabindex="-1"><a class="header-anchor" href="#thread-loader" aria-hidden="true">#</a> thread-loader</h4><p>官方开启多进程loader，可对babel、swc解析AST时开启多线程处理，提升编译性能，遗憾的是scss不支持，然后提升的性能不算太大，远不如swc和esbuild震撼，热更新时要提前开启</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code>threadLoader<span class="token punctuation">.</span><span class="token function">warmup</span><span class="token punctuation">(</span>
    <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span>
        <span class="token comment">// 子进程中需要预加载的 node 模块</span>
        <span class="token string">&quot;swc-loader&quot;</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="打包体积优化" tabindex="-1"><a class="header-anchor" href="#打包体积优化" aria-hidden="true">#</a> 打包体积优化</h3><h4 id="分析" tabindex="-1"><a class="header-anchor" href="#分析" aria-hidden="true">#</a> 分析</h4><p>webpack-bundle-analyzer插件分析各个chunk的打包体积，</p><p>stat: 每个模块初始体积<br> parsed: webpack打包后的体积，terser压缩后<br> gzip: 经gzip压缩后的体积</p><p>设置环境变量开启插件</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token parameter"><span class="token constant">ANALYZE</span></span> <span class="token operator">=&gt;</span> <span class="token constant">ANALYZE</span><span class="token operator">=</span><span class="token boolean">true</span> <span class="token operator">&amp;&amp;</span> npm run build
process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token parameter">npm_config_report</span>  <span class="token operator">=&gt;</span> npm run build <span class="token operator">--</span>report
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="js压缩" tabindex="-1"><a class="header-anchor" href="#js压缩" aria-hidden="true">#</a> JS压缩</h4><p>webpack默认开启</p><p>这个过程就是</p><ol><li>去除多余字符空格、换行和注释</li><li>压缩变量名：变量名、函数名和属性名</li><li>合并声明以及布尔值简化</li><li>编译预计算</li></ol><h4 id="treeshaking" tabindex="-1"><a class="header-anchor" href="#treeshaking" aria-hidden="true">#</a> TreeShaking</h4><p>json也支持，尽量使用支持esm的包，因为只有esm支持摇树</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token comment">// webpack.config.js</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">mode</span><span class="token operator">:</span> <span class="token string">&quot;production&quot;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">optimization</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">usedExports</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="使用-scope-hoisting-合并模块" tabindex="-1"><a class="header-anchor" href="#使用-scope-hoisting-合并模块" aria-hidden="true">#</a> 使用 Scope Hoisting 合并模块</h4><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">const</span> ModuleConcatenationPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;webpack/lib/optimize/ModuleConcatenationPlugin&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">// 方法1： 将 \`mode\` 设置为 production，即可开启</span>
    <span class="token literal-property property">mode</span><span class="token operator">:</span> <span class="token string">&quot;production&quot;</span><span class="token punctuation">,</span>
    <span class="token comment">// 方法2： 将 \`optimization.concatenateModules\` 设置为 true</span>
    <span class="token literal-property property">optimization</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">concatenateModules</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token literal-property property">usedExports</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token literal-property property">providedExports</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// 方法3： 直接使用 \`ModuleConcatenationPlugin\` 插件</span>
    <span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token keyword">new</span> <span class="token class-name">ModuleConcatenationPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="external-cdn" tabindex="-1"><a class="header-anchor" href="#external-cdn" aria-hidden="true">#</a> external cdn</h4><p>external 使用cdn引入</p><h4 id="polyfill-core-js" tabindex="-1"><a class="header-anchor" href="#polyfill-core-js" aria-hidden="true">#</a> polyfill core-js</h4><p>在使用babel的时候一般我们会使用 @babel/plugin-transform-runtime 并配置 corejs为 3 useBuiltIn已经被废弃了，现在babel会默认使用usage</p><p>在swc中我们可以开启 env中coreJs，区别是需要指定具体版本，swc的corejs也是依赖babel去引用的 mode:usage 可以按需引入</p><p>对于swc和babel函数可以通过 externalHelpers: true 或者 helpers: true（默认） 分离，我在开发代码库的时候是这样做的，这样可以进一步减小代码体积</p><p>垫片的加入包括css中autoprefixer都需要依赖browserslist这个库，这个库和canIUse是一家的可以统计不同api和css的兼容性，然后只加入不兼容的</p><p>但browserslist并不维护数据库，由于lock文件需要你手动更新 caniuse-lite</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code>npx browserslist@latest <span class="token operator">--</span>update<span class="token operator">-</span>db
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h4 id="高效分包" tabindex="-1"><a class="header-anchor" href="#高效分包" aria-hidden="true">#</a> 高效分包</h4><h5 id="为什么分包" tabindex="-1"><a class="header-anchor" href="#为什么分包" aria-hidden="true">#</a> 为什么分包</h5><p>代码太碎，http1.0响应头占用带宽、并行加载问题</p><p>代码太大，加载慢、首屏慢</p><p>分包按需加载</p><p>Code Splitting</p><h5 id="分包思路" tabindex="-1"><a class="header-anchor" href="#分包思路" aria-hidden="true">#</a> 分包思路</h5><ol><li>runtime 单独抽离</li></ol><p>webpack(或其他构建工具) 运行时代码不容易变更，需要单独抽离出来，比如 webpack.runtime.js。由于其体积小，必要时可注入 index.html 中，减少 HTTP 请求数，优化关键请求路径。有时注入到文件里会影响文件的hash，导致文件缓存失效</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token punctuation">{</span>
    <span class="token literal-property property">splitChunks</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token comment">// 单独抽离运行时</span>
        <span class="token literal-property property">runtimeChunk</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token literal-property property">cacheGroups</span><span class="token operator">:</span> <span class="token punctuation">{</span>

        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="2"><li>framework.runtime 单独抽离</li></ol><p>React(Vue) 运行时代码不容易变更，且每个组件都会依赖它，可单独抽离出来 framework.runtime.js</p><ol start="3"><li>高频库</li></ol><p>如果一个模块虽是公共模块，但是该模块体积过大，可直接 import() 引入，异步加载，单独分包，比如 echarts 等</p><p>如果公共模块数量多，导致 vendor.js 体积过大(1MB)，每个页面都会加载它，导致性能变差，此时如何分包</p><p>答：有以下两个思路</p><p>思路一: 可对 vendor.js 改变策略，比如被引用了十次以上，被当做公共模块抽离成 verdor-A.js，五次的抽离为 vendor-B.js，两次的抽离为 vendor-C.js 思路二: 控制 vendor.js 的体积，当大于 100KB 时，再次进行分包，多分几个 vendor-XXX.js，但每个 vendor.js 都不超过 100KB</p><h5 id="next-js的分包思路" tabindex="-1"><a class="header-anchor" href="#next-js的分包思路" aria-hidden="true">#</a> next.js的分包思路</h5><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token punctuation">{</span>
  <span class="token comment">// Keep main and _app chunks unsplitted in webpack 5</span>
  <span class="token comment">// as we don&#39;t need a separate vendor chunk from that</span>
  <span class="token comment">// and all other chunk depend on them so there is no</span>
  <span class="token comment">// duplication that need to be pulled out.</span>
  <span class="token function-variable function">chunks</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">chunk</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
    <span class="token operator">!</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^(polyfills|main|pages\\/_app)$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>chunk<span class="token punctuation">.</span>name<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
    <span class="token operator">!</span><span class="token constant">MIDDLEWARE_ROUTE</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>chunk<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token literal-property property">cacheGroups</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">framework</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token function-variable function">chunks</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">chunk</span><span class="token operator">:</span> webpack<span class="token punctuation">.</span>compilation<span class="token punctuation">.</span>Chunk</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
        <span class="token operator">!</span>chunk<span class="token punctuation">.</span>name<span class="token operator">?.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token constant">MIDDLEWARE_ROUTE</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&#39;framework&#39;</span><span class="token punctuation">,</span>
      <span class="token function">test</span><span class="token punctuation">(</span><span class="token parameter">module</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> resource <span class="token operator">=</span>
          module<span class="token punctuation">.</span>nameForCondition <span class="token operator">&amp;&amp;</span> module<span class="token punctuation">.</span><span class="token function">nameForCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>resource<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> <span class="token boolean">false</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> topLevelFrameworkPaths<span class="token punctuation">.</span><span class="token function">some</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">packagePath</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
          resource<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span>packagePath<span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token literal-property property">priority</span><span class="token operator">:</span> <span class="token number">40</span><span class="token punctuation">,</span>
      <span class="token comment">// Don&#39;t let webpack eliminate this chunk (prevents this chunk from</span>
      <span class="token comment">// becoming a part of the commons chunk)</span>
      <span class="token literal-property property">enforce</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">lib</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token function">test</span><span class="token punctuation">(</span>module<span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">size</span><span class="token operator">:</span> Function
        <span class="token literal-property property">nameForCondition</span><span class="token operator">:</span> Function
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token operator">:</span> boolean <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>
          module<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">160000</span> <span class="token operator">&amp;&amp;</span>
          <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">node_modules[/\\\\]</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span><span class="token function">nameForCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token function">name</span><span class="token punctuation">(</span>module<span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">type</span><span class="token operator">:</span> string
        libIdent<span class="token operator">?</span><span class="token operator">:</span> Function
        <span class="token function-variable function">updateHash</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">hash</span><span class="token operator">:</span> crypto<span class="token punctuation">.</span>Hash</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token operator">:</span> string <span class="token punctuation">{</span>
        <span class="token keyword">const</span> hash <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">createHash</span><span class="token punctuation">(</span><span class="token string">&#39;sha1&#39;</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isModuleCSS</span><span class="token punctuation">(</span>module<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          module<span class="token punctuation">.</span><span class="token function">updateHash</span><span class="token punctuation">(</span>hash<span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>module<span class="token punctuation">.</span>libIdent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>
              <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">Encountered unknown module type: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>module<span class="token punctuation">.</span>type<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">. Please open an issue.</span><span class="token template-punctuation string">\`</span></span>
            <span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
 
          hash<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span><span class="token function">libIdent</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">context</span><span class="token operator">:</span> dir <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
 
        <span class="token keyword">return</span> hash<span class="token punctuation">.</span><span class="token function">digest</span><span class="token punctuation">(</span><span class="token string">&#39;hex&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token literal-property property">priority</span><span class="token operator">:</span> <span class="token number">30</span><span class="token punctuation">,</span>
      <span class="token literal-property property">minChunks</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
      <span class="token literal-property property">reuseExistingChunk</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">commons</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&#39;commons&#39;</span><span class="token punctuation">,</span>
      <span class="token literal-property property">minChunks</span><span class="token operator">:</span> totalPages<span class="token punctuation">,</span>
      <span class="token literal-property property">priority</span><span class="token operator">:</span> <span class="token number">20</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">middleware</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token function-variable function">chunks</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">chunk</span><span class="token operator">:</span> webpack<span class="token punctuation">.</span>compilation<span class="token punctuation">.</span>Chunk</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
        chunk<span class="token punctuation">.</span>name<span class="token operator">?.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token constant">MIDDLEWARE_ROUTE</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token literal-property property">filename</span><span class="token operator">:</span> <span class="token string">&#39;server/middleware-chunks/[name].js&#39;</span><span class="token punctuation">,</span>
      <span class="token literal-property property">minChunks</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
      <span class="token literal-property property">enforce</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">maxInitialRequests</span><span class="token operator">:</span> <span class="token number">25</span><span class="token punctuation">,</span>
  <span class="token literal-property property">minSize</span><span class="token operator">:</span> <span class="token number">20000</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="我的最佳实践" tabindex="-1"><a class="header-anchor" href="#我的最佳实践" aria-hidden="true">#</a> 我的最佳实践</h5><p>由于我的项目是离线项目，不涉及http请求，所以我选择尽可能的分包，将所有依赖的库单独打包，如果http2也可以采用该策略,如果是http1的话，最大请求数则不应该超过30个。在rspack中name不支持函数</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token punctuation">{</span>
    <span class="token literal-property property">chunks</span><span class="token operator">:</span> <span class="token string">&quot;all&quot;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">maxInitialRequests</span><span class="token operator">:</span> <span class="token number">Infinity</span><span class="token punctuation">,</span>
    <span class="token literal-property property">minSize</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token comment">// 限制每个包体积不超过244KB</span>
    <span class="token literal-property property">maxSize</span><span class="token operator">:</span> <span class="token number">244</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">,</span>
    <span class="token literal-property property">cacheGroups</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">vendor</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token literal-property property">priority</span><span class="token operator">:</span> <span class="token number">100</span><span class="token punctuation">,</span>
            <span class="token literal-property property">test</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">[\\\\/]node_modules[\\\\/]</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
            <span class="token literal-property property">minChunks</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
            <span class="token function">name</span><span class="token punctuation">(</span><span class="token parameter">module</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">const</span> match <span class="token operator">=</span> module<span class="token punctuation">.</span>context<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>
                <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">[\\\\/]node_modules[\\\\/](.*?)([\\\\/]|$)</span><span class="token regex-delimiter">/</span></span>
                <span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">const</span> packageName <span class="token operator">=</span> match <span class="token operator">?</span> match<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token string">&quot;other&quot;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>packageName<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">&#39;@up366&#39;</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">const</span> match <span class="token operator">=</span> module<span class="token punctuation">.</span>context<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>
                        <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">[\\\\/]node_modules[\\\\/](.*?)([\\\\/]|$)(.*?)([\\\\/]|$)</span><span class="token regex-delimiter">/</span></span>
                    <span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">const</span> packageName <span class="token operator">=</span> match <span class="token operator">?</span> match<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token string">&quot;other&quot;</span>
                    <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">npm.up366.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>packageName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">npm.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>packageName<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">&quot;@&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token literal-property property">common</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token comment">// 重复代码抽离分包</span>
            <span class="token literal-property property">minChunks</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
            <span class="token literal-property property">reuseExistingChunk</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
            <span class="token literal-property property">priority</span><span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="监控产物体积" tabindex="-1"><a class="header-anchor" href="#监控产物体积" aria-hidden="true">#</a> 监控产物体积</h4><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token literal-property property">performance</span><span class="token operator">:</span> <span class="token punctuation">{</span>    
    <span class="token comment">// 设置所有产物体积阈值</span>
    <span class="token literal-property property">maxAssetSize</span><span class="token operator">:</span> <span class="token number">172</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">,</span>
    <span class="token comment">// 设置 entry 产物体积阈值</span>
    <span class="token literal-property property">maxEntrypointSize</span><span class="token operator">:</span> <span class="token number">244</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">,</span>
    <span class="token comment">// 报错方式，支持 \`error\` | \`warning\` | false</span>
    <span class="token literal-property property">hints</span><span class="token operator">:</span> <span class="token string">&quot;error&quot;</span><span class="token punctuation">,</span>
    <span class="token comment">// 过滤需要监控的文件类型</span>
    <span class="token function-variable function">assetFilter</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">assetFilename</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> assetFilename<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">&quot;.js&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="缓存策略" tabindex="-1"><a class="header-anchor" href="#缓存策略" aria-hidden="true">#</a> 缓存策略</h2><p>使用webpack打包器打包时生成hash，哈希分为三种，contentHash、chunkHash、hash，所以服务端对这些资源都可以设置永久缓存</p><p>通过在服务器端/网关端对资源设置以下 Response Header，进行强缓存一年时间，称为永久缓存，即 Long Term Cache。</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>Cache-Control: public,max-age=31536000,immutable
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="改变某个文件导致另一个文件发生变化" tabindex="-1"><a class="header-anchor" href="#改变某个文件导致另一个文件发生变化" aria-hidden="true">#</a> 改变某个文件导致另一个文件发生变化</h3><p>比如文件A， index.js.文件B， lib.js， 文件A引用文件B，当我改变文件B时会导致文件A打包后的哈希后缀发生变化，此时要想增强缓存能力，则需要开启 <code>chunkIds: &#39;deterministic&#39;</code></p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>{
  optimization: {
    chunkIds: &#39;deterministic&#39;
  }
}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="关于loader详情" tabindex="-1"><a class="header-anchor" href="#关于loader详情" aria-hidden="true">#</a> 关于Loader详情</h2>`,148),u={id:"手写loader",tabindex:"-1"},d=n("a",{class:"header-anchor",href:"#手写loader","aria-hidden":"true"},"#",-1),k={href:"https://juejin.cn/book/7115598540721618944/section/7119035404715556879?enter_from=course_center&utm_source=course_center",target:"_blank",rel:"noopener noreferrer"},v=a(`<p>Loader 接收三个参数，分别为：</p><p>source：资源输入，对于第一个执行的 Loader 为资源文件的内容；后续执行的 Loader 则为前一个 Loader 的执行结果，可能是字符串，也可能是代码的 AST 结构；<br> sourceMap: 可选参数，代码的 sourcemap 结构；<br> data: 可选参数，其它需要在 Loader 链中传递的信息，比如 posthtml/posthtml-loader 就会通过这个参数传递额外的 AST 对象。</p><ol><li>通过 this.getOptions 接口获取 Loader 配置对象；</li><li>使用 schema-utils 的 validate 接口校验 Loader 配置是否符合预期，配置 Schema 定义在 src/options.json 文件；</li><li>返回经过修改的内容。</li></ol><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> validate <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;schema-utils&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> schema <span class="token keyword">from</span> <span class="token string">&quot;./options.json&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">loader</span><span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> version<span class="token punctuation">,</span> webpack <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
  <span class="token comment">// 获取配置信息</span>
  <span class="token keyword">const</span> options <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 数据校验</span>
  <span class="token function">validate</span><span class="token punctuation">(</span>schema<span class="token punctuation">,</span> options<span class="token punctuation">,</span> <span class="token string">&quot;Loader&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> newSource <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">
  /**
   * Loader API Version: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>version<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">
   * Is this in &quot;webpack mode&quot;: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>webpack<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">
   */
  /**
   * Original Source From Loader
   */
  </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>source<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> newSource<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="多种格式的loader" tabindex="-1"><a class="header-anchor" href="#多种格式的loader" aria-hidden="true">#</a> 多种格式的loader</h4><p>资源加载，从资源输入到输出，是一个管道机制</p><p>结果要求必须是javascript代码，不然就得用另一个loader接着,比如用html-loader接着自己的markdown-loader</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code>module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">console.log(&#39;hello ~&#39;)</span><span class="token template-punctuation string">\`</span></span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code>module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> html <span class="token operator">=</span> <span class="token function">marked</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">module.exports = </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>html<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code>module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> html <span class="token operator">=</span> <span class="token function">marked</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">export default </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>html<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="指定loader" tabindex="-1"><a class="header-anchor" href="#指定loader" aria-hidden="true">#</a> 指定loader</h4><ol><li>绝对路径</li><li>将 resolveLoader.modules 配置指向到 Loader 所在目录，Webpack 会在该目录查找加载器</li></ol><h4 id="loader-常用接口" tabindex="-1"><a class="header-anchor" href="#loader-常用接口" aria-hidden="true">#</a> Loader 常用接口</h4><ul><li>fs：Compilation 对象的 inputFileSystem 属性，我们可以通过这个对象获取更多资源文件的内容；</li><li>resource：当前文件路径；</li><li>resourceQuery：文件请求参数，例如 import &quot;./a?foo=bar&quot; 的 resourceQuery 值为 ?foo=bar；</li><li>callback：可用于返回多个结果；</li><li>getOptions：用于获取当前 Loader 的配置对象；</li><li>async：用于声明这是一个异步 Loader，开发者需要通过 async 接口返回的 callback 函数传递处理结果；</li><li>emitWarning：添加警告；</li><li>emitError：添加错误信息，注意这不会中断 Webpack 运行；</li><li>emitFile：用于直接写出一个产物文件，例如 file-loader 依赖该接口写出 Chunk 之外的产物；</li><li>addDependency：将 dep 文件添加为编译依赖，当 dep 文件内容发生变化时，会触发当前文件的重新构建；</li></ul><h4 id="取消loader缓存" tabindex="-1"><a class="header-anchor" href="#取消loader缓存" aria-hidden="true">#</a> 取消Loader缓存</h4><p>需要注意，Loader 中执行的各种资源内容转译操作通常都是 CPU 密集型 —— 这放在 JavaScript 单线程架构下可能导致性能问题；又或者异步 Loader 会挂起后续的加载器队列直到异步 Loader 触发回调，稍微不注意就可能导致整个加载器链条的执行时间过长。</p><p>为此，Webpack 默认会缓存 Loader 的执行结果直到资源或资源依赖发生变化，开发者需要对此有个基本的理解，必要时可以通过 this.cachable 显式声明不作缓存：</p><h4 id="loader返回多个结果" tabindex="-1"><a class="header-anchor" href="#loader返回多个结果" aria-hidden="true">#</a> Loader返回多个结果</h4><p>通过callback</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">callback</span><span class="token punctuation">(</span>
    <span class="token comment">// 异常信息，Loader 正常运行时传递 null 值即可</span>
    <span class="token literal-property property">err</span><span class="token operator">:</span> Error <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    <span class="token comment">// 转译结果</span>
    <span class="token literal-property property">content</span><span class="token operator">:</span> string <span class="token operator">|</span> Buffer<span class="token punctuation">,</span>
    <span class="token comment">// 源码的 sourcemap 信息</span>
    sourceMap<span class="token operator">?</span><span class="token operator">:</span> SourceMap<span class="token punctuation">,</span>
    <span class="token comment">// 任意需要在 Loader 间传递的值</span>
    <span class="token comment">// 经常用来传递 ast 对象，避免重复解析</span>
    data<span class="token operator">?</span><span class="token operator">:</span> any
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="loader返回异步结果" tabindex="-1"><a class="header-anchor" href="#loader返回异步结果" aria-hidden="true">#</a> loader返回异步结果</h4><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">import</span> less <span class="token keyword">from</span> <span class="token string">&quot;less&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">lessLoader</span><span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 1. 获取异步回调函数</span>
  <span class="token keyword">const</span> callback <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">async</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ...</span>

  <span class="token keyword">let</span> result<span class="token punctuation">;</span>

  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token comment">// 2. 调用less 将模块内容转译为 css</span>
    result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>implementation <span class="token operator">||</span> less<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> lessOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> <span class="token punctuation">{</span> css<span class="token punctuation">,</span> imports <span class="token punctuation">}</span> <span class="token operator">=</span> result<span class="token punctuation">;</span>

  <span class="token comment">// ...</span>

  <span class="token comment">// 3. 转译结束，返回结果</span>
  <span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> css<span class="token punctuation">,</span> map<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> lessLoader<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="直接写出文件" tabindex="-1"><a class="header-anchor" href="#直接写出文件" aria-hidden="true">#</a> 直接写出文件</h4><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">loader</span><span class="token punctuation">(</span><span class="token parameter">content</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> options <span class="token operator">=</span> <span class="token function">getOptions</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">validate</span><span class="token punctuation">(</span>schema<span class="token punctuation">,</span> options<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&#39;File Loader&#39;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">baseDataPath</span><span class="token operator">:</span> <span class="token string">&#39;options&#39;</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ...</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> options<span class="token punctuation">.</span>emitFile <span class="token operator">===</span> <span class="token string">&#39;undefined&#39;</span> <span class="token operator">||</span> options<span class="token punctuation">.</span>emitFile<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">emitFile</span><span class="token punctuation">(</span>outputPath<span class="token punctuation">,</span> content<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> assetInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> esModule <span class="token operator">=</span>
    <span class="token keyword">typeof</span> options<span class="token punctuation">.</span>esModule <span class="token operator">!==</span> <span class="token string">&#39;undefined&#39;</span> <span class="token operator">?</span> options<span class="token punctuation">.</span>esModule <span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>esModule <span class="token operator">?</span> <span class="token string">&#39;export default&#39;</span> <span class="token operator">:</span> <span class="token string">&#39;module.exports =&#39;</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>publicPath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">;</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> raw <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="日志系统" tabindex="-1"><a class="header-anchor" href="#日志系统" aria-hidden="true">#</a> 日志系统</h4><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">loader</span><span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> logger <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token string">&quot;xxx-loader&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 使用适当的 logging 接口</span>
  <span class="token comment">// 支持：verbose/log/info/warn/error</span>
  logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;information&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> source<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="loader单元测试" tabindex="-1"><a class="header-anchor" href="#loader单元测试" aria-hidden="true">#</a> loader单元测试</h4><ol><li>创建在 Webpack 实例，并运行 Loader；</li><li>获取 Loader 执行结果，比对、分析判断是否符合预期；</li><li>判断执行过程中是否出错。</li></ol><h5 id="方法一" tabindex="-1"><a class="header-anchor" href="#方法一" aria-hidden="true">#</a> 方法一</h5><p>有两种办法，一是在 node 环境下运行调用 Webpack 接口，用代码而非命令行执行编译，很多框架都会采用这种方式，例如 vue-loader、stylus-loader、babel-loader 等，优点是运行效果最接近最终用户，缺点是运行效率相对较低（可以忽略）。</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token comment">// posthtml-loader/test/helpers/compiler.js 文件</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">fixture<span class="token punctuation">,</span> config<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  config <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token comment">/*...*/</span> <span class="token punctuation">}</span>

  options <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">output</span><span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span>

  <span class="token comment">// 创建 Webpack 实例</span>
  <span class="token keyword">const</span> compiler <span class="token operator">=</span> <span class="token function">webpack</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>

  <span class="token comment">// 以 MemoryFS 方式输出构建结果，避免写磁盘</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>options<span class="token punctuation">.</span>output<span class="token punctuation">)</span> compiler<span class="token punctuation">.</span>outputFileSystem <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MemoryFS</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token comment">// 执行，并以 promise 方式返回结果</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> compiler<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> stats</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
    <span class="token comment">// 异步返回执行结果</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span>stats<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="方法二" tabindex="-1"><a class="header-anchor" href="#方法二" aria-hidden="true">#</a> 方法二</h5><p>用的少，不讲</p><h4 id="pitch" tabindex="-1"><a class="header-anchor" href="#pitch" aria-hidden="true">#</a> pitch</h4><p>Webpack 允许在 Loader 函数上挂载名为 pitch 的函数，运行时 pitch 会比 Loader 本身更早执行，例如：</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token function-variable function">loader</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;后执行&#39;</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> source<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

loader<span class="token punctuation">.</span><span class="token function-variable function">pitch</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">requestString</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;先执行&#39;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> loader
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code><span class="token keyword">function</span> <span class="token function">pitch</span><span class="token punctuation">(</span>
    remainingRequest<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> previousRequest<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> data <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>包含三个参数：</p><ul><li>remainingRequest : 当前 loader 之后的资源请求字符串；</li><li>previousRequest : 在执行当前 loader 之前经历过的 loader 列表；</li><li>data : 与 Loader 函数的 data 相同，用于传递需要在 Loader 传播的信息。</li></ul><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token literal-property property">use</span><span class="token operator">:</span> <span class="token punctuation">[</span>
  <span class="token string">&quot;style-loader&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;css-loader&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;less-loader&quot;</span>
<span class="token punctuation">]</span><span class="token punctuation">,</span>


<span class="token comment">// css-loader 之后的 loader 列表及资源路径</span>
remainingRequest <span class="token operator">=</span> less<span class="token operator">-</span>loader<span class="token operator">!</span><span class="token punctuation">.</span><span class="token operator">/</span>xxx<span class="token punctuation">.</span>less
<span class="token comment">// css-loader 之前的 loader 列表</span>
previousRequest <span class="token operator">=</span> style<span class="token operator">-</span>loader
<span class="token comment">// 默认值</span>
data <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>实现上，Loader 链条执行过程分三个阶段：pitch、解析资源、执行，设计上与 DOM 的事件模型非常相似，pitch 对应到捕获阶段；执行对应到冒泡阶段；而两个阶段之间 Webpack 会执行资源内容的读取、解析操作，对应 DOM 事件模型的 AT_TARGET 阶段：</p><p>pitch 阶段按配置顺序从左到右逐个执行 loader.pitch 函数(如果有的话)，开发者可以在 pitch 返回任意值中断后续的链路的执行.pitch的意义就在于中断</p><div class="hint-container warning"><p class="hint-container-title">注意</p><ol><li>loader调用有优先级,可以通过enforce指定优先级，并且可以通过！符号在引入模块的时候定义是否要跳过某一种优先级的loader</li></ol><p>webpack.js.org 2. loader的调用有inline的方式，并且可以结合上面说的！符号指定跳过某些loader</p><p>webpack.js.org 3. pitch阶段的调用在normal之前，并且顺序和normal相反。详细过程见文章总结 4. pitch阶段某一个loader返回了值的话，就直接中断整个流程，把pitch的返回值作为本次文件的loader结果继续编译。比如上述的style-loader返回了对原来文件./xxx/less的引用，指定了使用css-loader less-loader loader继续加载，并且用了两个!!去跳过了配置文件中的所有loader防止无限递归。这里使用pitch起到了类似<strong>虚拟节点</strong>的作用</p></div><h4 id="loader-utils" tabindex="-1"><a class="header-anchor" href="#loader-utils" aria-hidden="true">#</a> loader-utils</h4><p>在 Webpack5 之前，loader-utils 是一个非常重要的 Loader 开发辅助工具</p><p>被裁减后的 loader-utils 仅保留了四个接口：</p><ol><li>urlToRequest：用于将模块路径转换为文件路径的工具函数；</li><li>isUrlRequest：用于判定字符串是否为模块请求路径；</li><li>getHashDigest：用于计算内容 Hash 值；</li><li>interpolateName：用于拼接文件名的模板工具；</li></ol><h4 id="vue-loader的实现" tabindex="-1"><a class="header-anchor" href="#vue-loader的实现" aria-hidden="true">#</a> vue-loader的实现</h4><p>先从结构说起，vue-loader 内部实际上包含了三个组件：</p><ol><li>lib/index.js 定义的 Normal Loader，负责将 Vue SFC 不同区块转化为 JavaScript import 语句，具体逻辑下面细讲；</li><li>lib/loaders/pitcher.js 定义的 Pitch Loader，负责遍历的 rules 数组，拼接出完整的行内引用路径；</li><li>lib/plugin.js 定义的插件，负责初始化编译环境，如复制原始 rules 配置等；</li></ol><p>vue-loader 运行过程大致上可以划分为两个阶段：</p><ol><li>预处理阶段：动态修改 Webpack 配置，注入 vue-loader 专用的一系列 module.rules；</li><li>内容处理阶段：Normal Loader 配合 Pitch Loader 完成文件内容转译。</li></ol><h5 id="预处理阶段" tabindex="-1"><a class="header-anchor" href="#预处理阶段" aria-hidden="true">#</a> 预处理阶段</h5><p>vue-loader 插件会在 apply 函数中动态修改 Webpack 配</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token comment">// 初始化pitch-loader</span>
<span class="token keyword">const</span> pitcher <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">loader</span><span class="token operator">:</span> require<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">&#39;./loaders/pitcher&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token function-variable function">resourceQuery</span><span class="token operator">:</span> <span class="token parameter">query</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>query<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token boolean">false</span> <span class="token punctuation">}</span>
    <span class="token keyword">const</span> parsed <span class="token operator">=</span> qs<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>query<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> parsed<span class="token punctuation">.</span>vue <span class="token operator">!=</span> <span class="token keyword">null</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>

<span class="token comment">// replace original rules</span>
compiler<span class="token punctuation">.</span>options<span class="token punctuation">.</span>module<span class="token punctuation">.</span>rules <span class="token operator">=</span> <span class="token punctuation">[</span>
  pitcher<span class="token punctuation">,</span>
  <span class="token operator">...</span>clonedRules<span class="token punctuation">,</span>
  <span class="token operator">...</span>rules
<span class="token punctuation">]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="插件架构" tabindex="-1"><a class="header-anchor" href="#插件架构" aria-hidden="true">#</a> 插件架构</h2><p>将 Webpack 的插件架构归类为“事件/订阅”模式，我认为这种归纳有失偏颇。订阅模式是一种松耦合架构，发布器只是在特定时机发布事件消息，订阅者并不或者很少与事件直接发生交互，举例来说，我们平常在使用 HTML 事件的时候很多时候只是在这个时机触发业务逻辑，很少调用上下文操作。</p><p>而 Webpack 的插件体系是一种基于 Tapable 实现的强耦合架构，它在特定时机触发钩子时会附带上足够的上下文信息，插件定义的钩子回调中，能也只能与这些上下文背后的数据结构、接口交互产生 side effect，进而影响到编译状态和后续流程。</p><p>Tapable 是 Webpack 插件架构的核心支架，但它的代码量其实很少，本质上就是围绕着 订阅/发布 模式叠加各种特化逻辑，适配 Webpack 体系下复杂的事件源-处理器之间交互需求，比如：</p><ul><li>有些场景需要支持将前一个处理器的结果传入下一个回调处理器；</li><li>有些场景需要支持异步并行调用这些回调处理器。</li></ul><h2 id="webpack执行流程" tabindex="-1"><a class="header-anchor" href="#webpack执行流程" aria-hidden="true">#</a> webpack执行流程</h2><ul><li>初始化阶段：修整配置参数，创建 Compiler、Compilation 等基础对象，并初始化插件及若干内置工厂、工具类，并最终根据 entry 配置，找到所有入口模块；</li><li>构建阶段：从 entry 文件开始，调用 loader 将模块转译为 JavaScript 代码，调用 Acorn 将代码转换为 AST 结构，遍历 AST 从中找出该模块依赖的模块；之后 递归 遍历所有依赖模块，找出依赖的依赖，直至遍历所有项目资源后，构建出完整的 模块依赖关系图；</li><li>生成阶段：根据 entry 配置，将模块组装为一个个 Chunk 对象，之后调用一系列 Template 工厂类翻译 Chunk 代码并封装为 Asset，最后写出到文件系统。</li></ul><h2 id="实践-在异步模块中使用-tree-shaking" tabindex="-1"><a class="header-anchor" href="#实践-在异步模块中使用-tree-shaking" aria-hidden="true">#</a> 实践：在异步模块中使用 Tree-Shaking</h2><p>Webpack5 之后，我们还可以用一种特殊的备注语法，实现异步模块的 Tree-Shaking 功能，例如：</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">import</span><span class="token punctuation">(</span><span class="token comment">/*webpackExports: [&quot;foo&quot;, &quot;default&quot;]*/</span> <span class="token string">&quot;./foo&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">module</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span>foo<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>示例中，通过 <code>/*webpackExports: xxx*/</code> 备注语句，显式声明即将消费异步模块的那些导出内容，Webpack 即可借此判断模块依赖，实现 Tree-Shaking。</p><h2 id="热更新实现原理" tabindex="-1"><a class="header-anchor" href="#热更新实现原理" aria-hidden="true">#</a> 热更新实现原理</h2><p>Webpack HMR 特性的执行过程并不复杂，核心：</p><ol><li>使用 webpack-dev-server （后面简称 WDS）托管静态资源，同时以 Runtime 方式注入一段处理 HMR 逻辑的客户端代码；</li><li>浏览器加载页面后，与 WDS 建立 WebSocket 连接；</li><li>Webpack 监听到文件变化后，增量构建发生变更的模块，并通过 WebSocket 发送 hash 事件；</li><li>浏览器接收到 hash 事件后，请求 manifest 资源文件，确认增量变更范围；</li><li>浏览器加载发生变更的增量模块；</li><li>Webpack 运行时触发变更模块的 module.hot.accept 回调，执行代码变更逻辑；</li><li>done。</li></ol><div class="language-typescript line-numbers-mode" data-ext="ts"><pre class="language-typescript"><code>module<span class="token punctuation">.</span>hot<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span>path<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> callback<span class="token operator">?</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="accept使用注意" tabindex="-1"><a class="header-anchor" href="#accept使用注意" aria-hidden="true">#</a> accept使用注意</h3><ol><li>处理失败兜底逻辑</li><li>冒泡机制 底下的依赖自底向上冒泡</li><li>使用无参数调用风格：作用是捕获当前文件的变更事件，并从模块第一行开始重新运行该模块的代码</li></ol>`,72);function m(b,h){const e=t("ExternalLinkIcon");return o(),c("div",null,[r,n("h3",u,[d,s(),n("a",k,[s("手写Loader"),i(e)])]),v])}const y=p(l,[["render",m],["__file","002webpack配置.html.vue"]]);export{y as default};
